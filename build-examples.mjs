#!/usr/bin/env node

// Reads .dgmo files from charts/ and diagrams/, .md files from docs/,
// and generates dist/examples.ts for consumption by diagrammo-app.

import { readdirSync, readFileSync, mkdirSync, writeFileSync } from 'node:fs';
import { join, basename, extname, resolve } from 'node:path';
import { fileURLToPath } from 'node:url';

const __dirname = fileURLToPath(new URL('.', import.meta.url));

function readDgmoFiles(dir, category) {
  const fullDir = resolve(__dirname, dir);
  let files;
  try {
    files = readdirSync(fullDir).filter((f) => f.endsWith('.dgmo')).sort();
  } catch {
    return [];
  }
  return files.map((f) => ({
    filename: basename(f, '.dgmo'),
    category,
    content: readFileSync(join(fullDir, f), 'utf-8'),
  }));
}

function readMdFiles(dir) {
  const fullDir = resolve(__dirname, dir);
  let files;
  try {
    files = readdirSync(fullDir).filter((f) => f.endsWith('.md')).sort();
  } catch {
    return [];
  }
  return files.map((f) => ({
    filename: basename(f, '.md'),
    content: readFileSync(join(fullDir, f), 'utf-8'),
  }));
}

const charts = readDgmoFiles('charts', 'charts');
const diagrams = readDgmoFiles('diagrams', 'diagrams');
const dgmoExamples = [...charts, ...diagrams];
const markdownExamples = readMdFiles('docs');

// Generate TypeScript source
const lines = [
  '// Auto-generated by build-examples.mjs â€” do not edit',
  '',
  'export interface DgmoExample {',
  '  filename: string;',
  '  content: string;',
  '  category: string;',
  '}',
  '',
  'export interface MarkdownExample {',
  '  filename: string;',
  '  content: string;',
  '}',
  '',
  `export const DGMO_EXAMPLES: DgmoExample[] = ${JSON.stringify(dgmoExamples, null, 2)};`,
  '',
  `export const MARKDOWN_EXAMPLES: MarkdownExample[] = ${JSON.stringify(markdownExamples, null, 2)};`,
  '',
];

const distDir = resolve(__dirname, 'dist');
mkdirSync(distDir, { recursive: true });
writeFileSync(join(distDir, 'examples.ts'), lines.join('\n'));

console.log(
  `Generated dist/examples.ts: ${dgmoExamples.length} dgmo + ${markdownExamples.length} markdown examples`
);
